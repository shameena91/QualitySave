{{> headr}}

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f1f3f6;
  }
  .shipping {
    background-color: #fff;
    padding: 20px;
    border-radius: 5px;
  }
</style>

<div class="container my-5">
  <div class="row justify-content-between">
    
    <!-- Left Column: Address and Products -->
    <div class="col-lg-8">
      
      <!-- Shipping Address Section -->
      <h4 class="mb-3">Shipping Address</h4>
      {{#each addresses}}
      <div class="mb-3 shipping">
        <div class="form-check border rounded p-3 mb-2">
<input
 class="form-check-input"
 type="radio" 
name="address"
 data-id="{{this._id}}" 
id="address-{{this._id}}"
  {{#if this.isDefault}}checked{{else}}{{#if @first}}checked{{/if}}{{/if}} />          
  
  <label class="form-check-label" for="address{{@index}}">
            <span class="border px-2 py-1 bg-light">{{this.addressType}}</span>
            <p class="mb-1 mt-2">
              <strong class="text-uppercase">{{this.fullName}}</strong> &nbsp; {{this.phone}}
            </p>
            <p class="mb-1">{{this.houseDetails}}, {{this.city}}, {{this.state}} - <strong>{{this.pincode}}</strong></p>
            {{#if this.altPhone}}<p class="mb-1">Alt Phone: {{this.altPhone}}</p>{{/if}}
            {{#if this.landMark}}<p class="mb-0">Landmark: {{this.landMark}}</p>{{/if}}
          </label>
          <button class="btn btn-sm btn-outline-primary float-end mt-2">Edit</button>
        </div>
      </div>
      {{/each}}
      <button class="btn btn-success mt-2">+ Add New Address</button>

      <!-- Order Summary Section -->
      <h4 class="mt-5 mb-3">Order Summary</h4>
      {{#each cartProducts}}
      
      <div class="card mb-3">
        <div class="row g-0 p-3">
          <div class="col-md-2">
            <img src="/uploads/re-image/{{this.productId.productImage.[0]}}" 
            class="img-fluid rounded"
             alt="{{this.productId.productName}}" 
             style="height:120px;width:120px;padding:15px" />
          </div>
          <div class="col-md-10">
            <div class="card-body p-0">
              <h6 class="card-title">{{this.productId.productName}}</h6>
              <p class="mb-1">Qty: {{this.quantity}}</p>
              <p class="mb-1">Price: ₹{{this.price}}</p>
              <p class="mb-0 fw-bold">Item Total: ₹{{this.totalPrice}}</p>
            </div>
          </div>
        </div>
      </div>
      {{/each}}
    

    </div>
<!-- Right Column: Price Summary -->
<!-- Right Column: Price Summary -->
<!-- Right Column: Price Summary -->
<div class="col-lg-4 mt-lg-0">
  <div class="card p-3 shadow-sm mt-5">
    <h5 class="mb-3">Price Details</h5>
    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between border-0">
        <span>Subtotal</span>
        <span>₹{{finalSalePrice}}</span>
      </li>
     
      <li class="list-group-item d-flex justify-content-between border-0">
        <span>Discount</span>
        <span class="text-success">-₹{{totalDiscount}}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between border-0">
        <span>Shipping</span>
        <span class="text-success text-bold">Free</span>
      </li>
      <li class="list-group-item d-flex justify-content-between border-0 pt-2 mb-3">
        <strong class="fs-5">Total</strong>
        <strong class="text-primary fs-5" >₹{{finalTotalPrice}}</strong>
      </li>
    </ul>

    <!-- Payment Methods Section -->
    <h5 class="mb-3 mt-4">Select Payment Method</h5>
    <div class="mb-3">
      <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="creditCard" value="creditCard">
        <label class="form-check-label" for="creditCard">
          <i class="bi bi-credit-card" style="font-size: 20px;"></i> Credit Card
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="paypal" value="paypal">
        <label class="form-check-label" for="paypal">
          <i class="bi bi-paypal" style="font-size: 20px;"></i> PayPal
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod">
        <label class="form-check-label" for="cod">
          <i class="bi bi-cash" style="font-size: 20px;"></i> Cash on Delivery
        </label>
      </div>
    </div>

    <button class="btn btn-primary w-100 mt-3" onclick="createOrder()">Proceed to Payment</button>
  </div>
</div>



  </div>
</div>

{{> foote}}
<script>
 function createOrder() {
        const selectedAddressRadio = document.querySelector('input[name="address"]:checked');
    const selectedAddressId = selectedAddressRadio ? selectedAddressRadio.getAttribute('data-id') : null;

    const selectedPaymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
    const paymentMethod = selectedPaymentRadio ? selectedPaymentRadio.value : null;
   if (!selectedAddressId || !paymentMethod) {
     Swal.fire({
      title: 'Missing Information',
      text: 'Please select both an address and a payment method.',
      icon: 'warning',
      confirmButtonText: 'OK'
    });
    return;
    }

    $.ajax({
    url: '/createOrder',
    method: 'POST',
 
    data: {
      addressId: selectedAddressId,
      paymentMethod: paymentMethod
    },
    success: function (response) {
      Swal.fire({
        title: 'Order Placed!',
        text: 'Your order has been successfully created.',
        icon: 'success',
        confirmButtonText: 'OK'
      }).then(() => {
        window.location.href = `/orderSuccess/${response.orderId}`;
      });
      
    },
    error: function (error) {
      Swal.fire({
        title: 'Order Failed',
        text: 'Something went wrong. Please try again.',
        icon: 'error',
        confirmButtonText: 'OK'
      });
    }
  });
}
</script>

